<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard - Student Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar" aria-label="Main navigation">
        <div class="sidebar-header">
            <i class="fas fa-chalkboard-teacher fa-2x" aria-hidden="true"></i>
            <h3>Teacher Portal</h3>
        </div>
        <div class="sidebar-menu">
            <ul>
                <li><a href="#" onclick="showDashboard()" aria-label="Dashboard"><i class="fas fa-tachometer-alt" aria-hidden="true"></i> <span>Dashboard</span></a></li>
                <li><a href="#" onclick="showMyClasses()" aria-label="My Classes"><i class="fas fa-book-open" aria-hidden="true"></i> <span>My Classes</span></a></li>
                <li><a href="#" onclick="showStudents()" aria-label="Students"><i class="fas fa-users" aria-hidden="true"></i> <span>Students</span></a></li>
                <li><a href="#" onclick="showAttendance()" aria-label="Attendance"><i class="fas fa-clipboard-check" aria-hidden="true"></i> <span>Attendance</span></a></li>
                <li><a href="#" onclick="showGrades()" aria-label="Grades"><i class="fas fa-graduation-cap" aria-hidden="true"></i> <span>Grades</span></a></li>
                <li><a href="#" onclick="showAnnouncements()" aria-label="Announcements"><i class="fas fa-bullhorn" aria-hidden="true"></i> <span>Announcements</span></a></li>
            </ul>
        </div>
        <div class="theme-switcher">
            <button data-theme="light">Light</button>
            <button data-theme="dark">Dark</button>
            <button data-theme="high-contrast">High Contrast</button>
            <button data-theme="blue">Blue</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      
        <!-- Dashboard Section -->
        <section id="dashboard-section" aria-labelledby="dashboard-heading">
            <!-- Header -->
            <div class="header">
                <h1 id="dashboard-heading">Teacher Dashboard</h1>
                <div class="user-profile" onclick="showProfile()" role="button" aria-haspopup="true" aria-expanded="false" aria-label="User profile">
                    <img id="user-avatar" src="https://ui-avatars.com/api/?name=Teacher+User&background=4361ee&color=fff" alt="Teacher User">
                    <div class="user-info">
                        <h4 id="user-name"></h4>
                        <p id="user-role"></p>
                    </div>
                </div>
                <div id="profile-dropdown" class="profile-dropdown">
                    <a href="#" onclick="showProfileModal()" role="menuitem">Profile Settings</a>
                    <a href="#" onclick="logout()" role="menuitem">Logout</a>
                </div>
            </div>

            <!-- Cards -->
            <div class="cards-container">
                <div class="card" role="region" aria-labelledby="classes-card-heading">
                    <div class="card-header">
                        <div>
                            <h3 id="classes-count">0</h3>
                            <p id="classes-card-heading">Classes</p>
                        </div>
                        <div class="card-icon classes">
                            <i class="fas fa-book-open" aria-hidden="true"></i>
                        </div>
                    </div>
                </div>

                <div class="card" role="region" aria-labelledby="students-card-heading">
                    <div class="card-header">
                        <div>
                            <h3 id="students-count">0</h3>
                            <p id="students-card-heading">Students</p>
                        </div>
                        <div class="card-icon students">
                            <i class="fas fa-users" aria-hidden="true"></i>
                        </div>
                    </div>
                </div>

                <div class="card" role="region" aria-labelledby="assignments-card-heading">
                    <div class="card-header">
                        <div>
                            <h3 id="assignments-count">0</h3>
                            <p id="assignments-card-heading">Assignments</p>
                        </div>
                        <div class="card-icon assignments">
                            <i class="fas fa-tasks" aria-hidden="true"></i>
                        </div>
                    </div>
                </div>

                <div class="card" role="region" aria-labelledby="announcements-card-heading">
                    <div class="card-header">
                        <div>
                            <h3 id="announcements-count">0</h3>
                            <p id="announcements-card-heading">Announcements</p>
                        </div>
                        <div class="card-icon announcements">
                            <i class="fas fa-bullhorn" aria-hidden="true"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Today's Schedule -->
            <div class="schedule" role="region" aria-labelledby="schedule-heading">
                <div class="section-header">
                    <h2 id="schedule-heading">Today's Schedule</h2>
                    <a href="#" role="button">View Full Schedule</a>
                </div>
                <ul class="schedule-list" id="schedule-list" aria-live="polite">
                    <!-- Schedule items will be loaded here -->
                </ul>
            </div>

            <!-- Pending Tasks -->
            <div class="pending-tasks" role="region" aria-labelledby="tasks-heading">
                <div class="section-header">
                    <h2 id="tasks-heading">Pending Tasks</h2>
                    <button class="btn btn-add" onclick="showAddTaskModal()" aria-label="Add new task">Add Task</button>
                </div>
                <div id="tasks-list" aria-live="polite">
                    <!-- Tasks will be loaded here -->
                </div>
            </div>
        </section>

        <!-- My Classes Section -->
        <section id="classes-section" style="display: none;" aria-labelledby="classes-heading">
            <div class="header">
                <h1 id="classes-heading">My Classes</h1>
                <button class="btn btn-add" onclick="showAddClassModal()" aria-label="Add new class">Add Class</button>
            </div>
            <div class="table-responsive">
                <table class="data-table" aria-describedby="classes-heading">
                    <thead>
                        <tr>
                            <th scope="col">Class ID</th>
                            <th scope="col">Subject</th>
                            <th scope="col">Grade</th>
                            <th scope="col">Schedule</th>
                            <th scope="col">Students</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="classes-table-body" aria-live="polite">
                        <!-- Classes will be loaded here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Students Section -->
        <section id="students-section" style="display: none;" aria-labelledby="students-heading">
            <div class="header">
                <h1 id="students-heading">My Students</h1>
            </div>
            <div class="table-responsive">
                <table class="data-table" aria-describedby="students-heading">
                    <thead>
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">Name</th>
                            <th scope="col">Class</th>
                            <th scope="col">Email</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="students-table-body" aria-live="polite">
                        <!-- Students will be loaded here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Attendance Section -->
        <section id="attendance-section" style="display: none;" aria-labelledby="attendance-heading">
            <div class="header">
                <h1 id="attendance-heading">Attendance Management</h1>
                <button class="btn btn-add" onclick="showTakeAttendanceModal()" aria-label="Take attendance">Take Attendance</button>
            </div>
            <div class="attendance-controls">
                <div class="form-group">
                    <label for="attendance-class">Select Class:</label>
                    <select id="attendance-class" onchange="loadClassAttendance()">
                        <!-- Classes will be loaded here -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="attendance-date">Select Date:</label>
                    <input type="date" id="attendance-date" onchange="loadClassAttendance()" value="">
                </div>
            </div>
            <div class="table-responsive">
                <table class="data-table" aria-describedby="attendance-heading">
                    <thead>
                        <tr>
                            <th scope="col">Student ID</th>
                            <th scope="col">Name</th>
                            <th scope="col">Status</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-table-body" aria-live="polite">
                        <!-- Attendance records will be loaded here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Grades Section -->
        <section id="grades-section" style="display: none;" aria-labelledby="grades-heading">
            <div class="header">
                <h1 id="grades-heading">Grade Management</h1>
                <button class="btn btn-add" onclick="showAddGradeModal()" aria-label="Add grade">Add Grade</button>
            </div>
            <div class="grades-controls">
                <div class="form-group">
                    <label for="grades-class">Select Class:</label>
                    <select id="grades-class" onchange="loadClassGrades()">
                        <!-- Classes will be loaded here -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="grades-assignment">Select Assignment:</label>
                    <select id="grades-assignment" onchange="loadClassGrades()">
                        <!-- Assignments will be loaded here -->
                    </select>
                </div>
            </div>
            <div class="table-responsive">
                <table class="data-table" aria-describedby="grades-heading">
                    <thead>
                        <tr>
                            <th scope="col">Student ID</th>
                            <th scope="col">Name</th>
                            <th scope="col">Grade</th>
                            <th scope="col">Comments</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="grades-table-body" aria-live="polite">
                        <!-- Grades will be loaded here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Announcements Section -->
        <section id="announcements-section" style="display: none;" aria-labelledby="announcements-heading">
            <div class="header">
                <h1 id="announcements-heading">Announcements</h1>
                <button class="btn btn-add" onclick="showAddAnnouncementModal()" aria-label="Add new announcement">Add Announcement</button>
            </div>
            <div class="table-responsive">
                <table class="data-table" aria-describedby="announcements-heading">
                    <thead>
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">Title</th>
                            <th scope="col">Date</th>
                            <th scope="col">Class</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="announcements-table-body" aria-live="polite">
                        <!-- Announcements will be loaded here -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- Add Class Modal -->
    <div id="class-modal" class="modal" role="dialog" aria-labelledby="class-modal-title" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="class-modal-title">Add New Class</h2>
                <button class="close-btn" onclick="closeModal('class-modal')" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="class-form">
                    <input type="hidden" id="class-id">
                    <div class="form-group">
                        <label for="class-subject">Subject</label>
                        <input type="text" id="class-subject" required aria-required="true">
                    </div>
                    <div class="form-group">
                        <label for="class-grade">Grade Level</label>
                        <select id="class-grade" required aria-required="true">
                            <option value="">Select Grade</option>
                            <option value="1">Grade 1</option>
                            <option value="2">Grade 2</option>
                            <!-- Add more grade levels as needed -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="class-schedule">Schedule</label>
                        <input type="text" id="class-schedule" placeholder="e.g., Mon/Wed/Fri 10:00-11:00" required aria-required="true">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-cancel" onclick="closeModal('class-modal')">Cancel</button>
                        <button type="submit" class="btn">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Take Attendance Modal -->
    <div id="attendance-modal" class="modal" role="dialog" aria-labelledby="attendance-modal-title" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="attendance-modal-title">Take Attendance</h2>
                <button class="close-btn" onclick="closeModal('attendance-modal')" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="attendance-form">
                    <div class="form-group">
                        <label for="attendance-modal-class">Class</label>
                        <select id="attendance-modal-class" required aria-required="true">
                            <!-- Classes will be loaded here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="attendance-modal-date">Date</label>
                        <input type="date" id="attendance-modal-date" required aria-required="true">
                    </div>
                    <div id="attendance-students-list">
                        <!-- Students will be loaded here with attendance options -->
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-cancel" onclick="closeModal('attendance-modal')">Cancel</button>
                        <button type="submit" class="btn">Submit Attendance</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Grade Modal -->
    <div id="grade-modal" class="modal" role="dialog" aria-labelledby="grade-modal-title" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="grade-modal-title">Add Grade</h2>
                <button class="close-btn" onclick="closeModal('grade-modal')" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="grade-form">
                    <input type="hidden" id="grade-id">
                    <div class="form-group">
                        <label for="grade-class">Class</label>
                        <select id="grade-class" required aria-required="true" onchange="loadStudentsForGrade()">
                            <!-- Classes will be loaded here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="grade-student">Student</label>
                        <select id="grade-student" required aria-required="true">
                            <!-- Students will be loaded here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="grade-assignment">Assignment</label>
                        <select id="grade-assignment" required aria-required="true">
                            <!-- Assignments will be loaded here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="grade-score">Score</label>
                        <input type="number" id="grade-score" min="0" max="100" step="0.1" required aria-required="true">
                    </div>
                    <div class="form-group">
                        <label for="grade-comments">Comments</label>
                        <textarea id="grade-comments"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-cancel" onclick="closeModal('grade-modal')">Cancel</button>
                        <button type="submit" class="btn">Save Grade</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Announcement Modal -->
    <div id="announcement-modal" class="modal" role="dialog" aria-labelledby="announcement-modal-title" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="announcement-modal-title">Add New Announcement</h2>
                <button class="close-btn" onclick="closeModal('announcement-modal')" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="announcement-form">
                    <input type="hidden" id="announcement-id">
                    <div class="form-group">
                        <label for="announcement-title">Title</label>
                        <input type="text" id="announcement-title" required aria-required="true">
                    </div>
                    <div class="form-group">
                        <label for="announcement-class">Class (optional)</label>
                        <select id="announcement-class">
                            <option value="">All Classes</option>
                            <!-- Classes will be loaded here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="announcement-content">Content</label>
                        <textarea id="announcement-content" required aria-required="true"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-cancel" onclick="closeModal('announcement-modal')">Cancel</button>
                        <button type="submit" class="btn">Post Announcement</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div id="task-modal" class="modal" role="dialog" aria-labelledby="task-modal-title" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="task-modal-title">Add New Task</h2>
                <button class="close-btn" onclick="closeModal('task-modal')" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="task-form">
                    <input type="hidden" id="task-id">
                    <div class="form-group">
                        <label for="task-title">Title</label>
                        <input type="text" id="task-title" required aria-required="true">
                    </div>
                    <div class="form-group">
                        <label for="task-due-date">Due Date</label>
                        <input type="datetime-local" id="task-due-date" required aria-required="true">
                    </div>
                    <div class="form-group">
                        <label for="task-priority">Priority</label>
                        <select id="task-priority" required aria-required="true">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="task-description">Description</label>
                        <textarea id="task-description"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-cancel" onclick="closeModal('task-modal')">Cancel</button>
                        <button type="submit" class="btn">Add Task</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal" role="dialog" aria-labelledby="profile-modal-title" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="profile-modal-title">Profile Settings</h2>
                <button class="close-btn" onclick="closeModal('profile-modal')" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="profile-form">
                    <div class="theme-switcher">
                        <label>Select Theme</label>
                        <button data-theme="light">Light</button>
                        <button data-theme="dark">Dark</button>
                        <button data-theme="high-contrast">High Contrast</button>
                        <button data-theme="blue">Blue</button>
                    </div>
                    <div class="form-group">
                        <label for="profile-name">Name</label>
                        <input type="text" id="profile-name" required aria-required="true">
                    </div>
                    <div class="form-group">
                        <label for="profile-email">Email</label>
                        <input type="email" id="profile-email" required aria-required="true">
                    </div>
                    <div class="form-group">
                        <label for="profile-subject">Subject</label>
                        <input type="text" id="profile-subject" required aria-required="true">
                    </div>
                    <div class="form-group">
                        <label for="profile-current-password">Current Password</label>
                        <input type="password" id="profile-current-password">
                    </div>
                    <div class="form-group">
                        <label for="profile-new-password">New Password</label>
                        <input type="password" id="profile-new-password">
                    </div>
                    <div class="form-group">
                        <label for="profile-confirm-password">Confirm New Password</label>
                        <input type="password" id="profile-confirm-password">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-cancel" onclick="closeModal('profile-modal')">Cancel</button>
                        <button type="submit" class="btn">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:3000/api';
        let authToken = localStorage.getItem('authToken');
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};

        // Helper function for authenticated API calls
        async function fetchData(endpoint, method = 'GET', body = null, requiresAuth = true) {
            const headers = {
                'Content-Type': 'application/json',
            };

            if (requiresAuth && authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }

            const config = {
                method,
                headers,
            };

            if (body) {
                config.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        logout();
                        throw new Error('Session expired. Please login again.');
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Request failed');
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Initialize the dashboard
        function initDashboard() {
            if (!authToken) {
                window.location.href = '/login.html';
                return;
            }
            
            loadUserProfile();
            setupEventListeners();
            showDashboard();
        }

        // Load user profile
        async function loadUserProfile() {
            try {
                const user = await fetchData('/auth/profile');
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                
                document.getElementById('user-name').textContent = user.full_name || 'Teacher User';
                document.getElementById('user-role').textContent = 'Teacher';
                
                const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.full_name || 'Teacher User')}&background=4361ee&color=fff`;
                document.getElementById('user-avatar').src = avatarUrl;
            } catch (error) {
                console.error('Failed to load user profile:', error);
                alert('Failed to load profile: ' + error.message);
                logout();
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Profile dropdown toggle
            document.querySelector('.user-profile').addEventListener('click', function() {
                document.getElementById('profile-dropdown').classList.toggle('show');
            });

            // Add form event listeners
            document.getElementById('class-form').addEventListener('submit', handleClassFormSubmit);
            document.getElementById('attendance-form').addEventListener('submit', handleAttendanceFormSubmit);
            document.getElementById('grade-form').addEventListener('submit', handleGradeFormSubmit);
            document.getElementById('announcement-form').addEventListener('submit', handleAnnouncementFormSubmit);
            document.getElementById('task-form').addEventListener('submit', handleTaskFormSubmit);
            document.getElementById('profile-form').addEventListener('submit', handleProfileFormSubmit);

            // Set today's date for attendance and other date fields
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendance-date').value = today;
            document.getElementById('attendance-modal-date').value = today;
        }

        // Navigation Functions
        function showDashboard() {
            hideAllSections();
            document.getElementById('dashboard-section').style.display = 'block';
            updateDashboardCounts();
            loadTodaysSchedule();
            loadPendingTasks();
            
            // Update active menu item
            document.querySelector('.sidebar-menu li:nth-child(1) a').classList.add('active');
            for (let i = 2; i <= 6; i++) {
                document.querySelector(`.sidebar-menu li:nth-child(${i}) a`).classList.remove('active');
            }
        }

        function showMyClasses() {
            hideAllSections();
            document.getElementById('classes-section').style.display = 'block';
            loadClasses();
            
            document.querySelector('.sidebar-menu li:nth-child(2) a').classList.add('active');
            document.querySelector('.sidebar-menu li:nth-child(1) a').classList.remove('active');
            for (let i = 3; i <= 6; i++) {
                document.querySelector(`.sidebar-menu li:nth-child(${i}) a`).classList.remove('active');
            }
        }

        function showStudents() {
            hideAllSections();
            document.getElementById('students-section').style.display = 'block';
            loadStudents();
            
            document.querySelector('.sidebar-menu li:nth-child(3) a').classList.add('active');
            for (let i = 1; i <= 2; i++) {
                document.querySelector(`.sidebar-menu li:nth-child(${i}) a`).classList.remove('active');
            }
            for (let i = 4; i <= 6; i++) {
                document.querySelector(`.sidebar-menu li:nth-child(${i}) a`).classList.remove('active');
            }
        }

        function showAttendance() {
            hideAllSections();
            document.getElementById('attendance-section').style.display = 'block';
            loadClassesForAttendance();
            
            document.querySelector('.sidebar-menu li:nth-child(4) a').classList.add('active');
            for (let i = 1; i <= 3; i++) {
                document.querySelector(`.sidebar-menu li:nth-child(${i}) a`).classList.remove('active');
            }
            for (let i = 5; i <= 6; i++) {
                document.querySelector(`.sidebar-menu li:nth-child(${i}) a`).classList.remove('active');
            }
        }

        function showGrades() {
            hideAllSections();
            document.getElementById('grades-section').style.display = 'block';
            loadClassesForGrades();
            
            document.querySelector('.sidebar-menu li:nth-child(5) a').classList.add('active');
            for (let i = 1; i <= 4; i++) {
                document.querySelector(`.sidebar-menu li:nth-child(${i}) a`).classList.remove('active');
            }
            document.querySelector('.sidebar-menu li:nth-child(6) a').classList.remove('active');
        }

        function showAnnouncements() {
            hideAllSections();
            document.getElementById('announcements-section').style.display = 'block';
            loadAnnouncements();
            
            document.querySelector('.sidebar-menu li:nth-child(6) a').classList.add('active');
            for (let i = 1; i <= 5; i++) {
                document.querySelector(`.sidebar-menu li:nth-child(${i}) a`).classList.remove('active');
            }
        }

        function hideAllSections() {
            document.getElementById('dashboard-section').style.display = 'none';
            document.getElementById('classes-section').style.display = 'none';
            document.getElementById('students-section').style.display = 'none';
            document.getElementById('attendance-section').style.display = 'none';
            document.getElementById('grades-section').style.display = 'none';
            document.getElementById('announcements-section').style.display = 'none';
        }

        // Modal Functions
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
            modal.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
            
            const form = document.getElementById(modalId.replace('-modal', '-form'));
            if (form) form.reset();
        }

        function showProfileModal() {
            document.getElementById('profile-name').value = currentUser.full_name || '';
            document.getElementById('profile-email').value = currentUser.email || '';
            document.getElementById('profile-subject').value = currentUser.subject || '';
            document.getElementById('profile-current-password').value = '';
            document.getElementById('profile-new-password').value = '';
            document.getElementById('profile-confirm-password').value = '';
            
            showModal('profile-modal');
        }

        function showAddClassModal() {
            document.getElementById('class-modal-title').textContent = 'Add New Class';
            document.getElementById('class-id').value = '';
            document.getElementById('class-form').reset();
            showModal('class-modal');
        }

        function showEditClassModal(cls) {
            document.getElementById('class-modal-title').textContent = 'Edit Class';
            document.getElementById('class-id').value = cls.id;
            document.getElementById('class-subject').value = cls.subject;
            document.getElementById('class-grade').value = cls.grade;
            document.getElementById('class-schedule').value = cls.schedule;
            showModal('class-modal');
        }

        function showTakeAttendanceModal() {
            document.getElementById('attendance-modal-title').textContent = 'Take Attendance';
            document.getElementById('attendance-form').reset();
            document.getElementById('attendance-modal-date').value = new Date().toISOString().split('T')[0];
            loadClassesForAttendanceModal();
            showModal('attendance-modal');
        }

        function showAddGradeModal() {
            document.getElementById('grade-modal-title').textContent = 'Add Grade';
            document.getElementById('grade-id').value = '';
            document.getElementById('grade-form').reset();
            loadClassesForGradesModal();
            showModal('grade-modal');
        }

        function showAddAnnouncementModal() {
            document.getElementById('announcement-modal-title').textContent = 'Add Announcement';
            document.getElementById('announcement-id').value = '';
            document.getElementById('announcement-form').reset();
            loadClassesForAnnouncement();
            showModal('announcement-modal');
        }

        function showAddTaskModal() {
            document.getElementById('task-modal-title').textContent = 'Add Task';
            document.getElementById('task-id').value = '';
            document.getElementById('task-form').reset();
            
            // Set default due date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('task-due-date').value = tomorrow.toISOString().slice(0, 16);
            
            showModal('task-modal');
        }

        // Data Loading Functions
        async function updateDashboardCounts() {
            try {
                const counts = await fetchData('/teacher/dashboard');
                document.getElementById('classes-count').textContent = counts.total_classes;
                document.getElementById('students-count').textContent = counts.total_students;
                document.getElementById('assignments-count').textContent = counts.total_assignments;
                document.getElementById('announcements-count').textContent = counts.total_announcements;
            } catch (error) {
                console.error('Failed to update dashboard counts:', error);
            }
        }

        async function loadTodaysSchedule() {
            try {
                const schedule = await fetchData('/teacher/schedule/today');
                const container = document.getElementById('schedule-list');
                container.innerHTML = '';
                
                if (schedule.length === 0) {
                    container.innerHTML = '<li class="no-items">No classes scheduled for today</li>';
                    return;
                }
                
                schedule.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'schedule-item';
                    li.innerHTML = `
                        <div class="schedule-time">${item.start_time} - ${item.end_time}</div>
                        <div class="schedule-info">
                            <h4>${item.subject} (Grade ${item.grade_level})</h4>
                            <p>${item.class_name}</p>
                        </div>
                    `;
                    container.appendChild(li);
                });
            } catch (error) {
                console.error('Failed to load schedule:', error);
            }
        }

        async function loadPendingTasks() {
            try {
                const tasks = await fetchData('/teacher/tasks/pending');
                const container = document.getElementById('tasks-list');
                container.innerHTML = '';
                
                if (tasks.length === 0) {
                    container.innerHTML = '<div class="no-items">No pending tasks</div>';
                    return;
                }
                
                tasks.forEach(task => {
                    const div = document.createElement('div');
                    div.className = 'task-item';
                    
                    let priorityClass = '';
                    if (task.priority === 'high') priorityClass = 'high-priority';
                    else if (task.priority === 'medium') priorityClass = 'medium-priority';
                    
                    div.innerHTML = `
                        <div class="task-header ${priorityClass}">
                            <h3>${task.title}</h3>
                            <div class="task-due">Due: ${new Date(task.due_date).toLocaleString()}</div>
                        </div>
                        <p>${task.description || 'No description'}</p>
                        <div class="task-actions">
                            <button class="action-btn complete-btn" onclick="completeTask('${task.id}')">Complete</button>
                            <button class="action-btn edit-btn" onclick="editTask('${task.id}')">Edit</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Failed to load tasks:', error);
            }
        }

        async function loadClasses() {
            try {
                const classes = await fetchData('/teacher/classes');
                const tbody = document.getElementById('classes-table-body');
                tbody.innerHTML = '';
                
                if (classes.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="no-items">No classes found. Add your first class!</td>
                        </tr>
                    `;
                    return;
                }
                
                classes.forEach(cls => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${cls.id}</td>
                        <td>${cls.subject}</td>
                        <td>Grade ${cls.grade_level}</td>
                        <td>${cls.schedule}</td>
                        <td>${cls.student_count}</td>
                        <td class="actions">
                            <button class="action-btn view-btn" onclick="viewClassDetails('${cls.id}')" aria-label="View class details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit-btn" onclick="showEditClassModal(${JSON.stringify(cls).replace(/"/g, '&quot;')})" aria-label="Edit class">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteClass('${cls.id}')" aria-label="Delete class">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Failed to load classes:', error);
                alert('Failed to load classes: ' + error.message);
            }
        }

        async function loadStudents() {
            try {
                const students = await fetchData('/teacher/students');
                const tbody = document.getElementById('students-table-body');
                tbody.innerHTML = '';
                
                if (students.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="no-items">No students found</td>
                        </tr>
                    `;
                    return;
                }
                
                students.forEach(student => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${student.id}</td>
                        <td>${student.full_name}</td>
                        <td>${student.class_name || 'Not assigned'}</td>
                        <td>${student.email}</td>
                        <td class="actions">
                            <button class="action-btn view-btn" onclick="viewStudentDetails('${student.id}')" aria-label="View student details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn message-btn" onclick="messageStudent('${student.id}')" aria-label="Message student">
                                <i class="fas fa-envelope"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Failed to load students:', error);
                alert('Failed to load students: ' + error.message);
            }
        }

        async function loadClassesForAttendance() {
            try {
                const classes = await fetchData('/teacher/classes');
                const select = document.getElementById('attendance-class');
                select.innerHTML = '<option value="">Select Class</option>';
                
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = `${cls.subject} (Grade ${cls.grade_level})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load classes for attendance:', error);
            }
        }

        async function loadClassAttendance() {
            const classId = document.getElementById('attendance-class').value;
            const date = document.getElementById('attendance-date').value;
            
            if (!classId || !date) {
                document.getElementById('attendance-table-body').innerHTML = `
                    <tr>
                        <td colspan="4" class="no-items">Select a class and date to view attendance</td>
                    </tr>
                `;
                return;
            }
            
            try {
                const attendance = await fetchData(`/teacher/attendance?class_id=${classId}&date=${date}`);
                const tbody = document.getElementById('attendance-table-body');
                tbody.innerHTML = '';
                
                if (attendance.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" class="no-items">No attendance records found for this date</td>
                        </tr>
                    `;
                    return;
                }
                
                attendance.forEach(record => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${record.student_id}</td>
                        <td>${record.student_name}</td>
                        <td>
                            <select class="attendance-status" data-student-id="${record.student_id}" onchange="updateAttendanceStatus('${classId}', '${date}', '${record.student_id}', this.value)">
                                <option value="present" ${record.status === 'present' ? 'selected' : ''}>Present</option>
                                <option value="absent" ${record.status === 'absent' ? 'selected' : ''}>Absent</option>
                                <option value="late" ${record.status === 'late' ? 'selected' : ''}>Late</option>
                                <option value="excused" ${record.status === 'excused' ? 'selected' : ''}>Excused</option>
                            </select>
                        </td>
                        <td class="actions">
                            <button class="action-btn notes-btn" onclick="showAttendanceNotes('${classId}', '${date}', '${record.student_id}')" aria-label="Add notes">
                                <i class="fas fa-comment"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Failed to load attendance:', error);
                alert('Failed to load attendance: ' + error.message);
            }
        }

        async function loadClassesForGrades() {
            try {
                const classes = await fetchData('/teacher/classes');
                const select = document.getElementById('grades-class');
                select.innerHTML = '<option value="">Select Class</option>';
                
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = `${cls.subject} (Grade ${cls.grade_level})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load classes for grades:', error);
            }
        }

        async function loadClassGrades() {
            const classId = document.getElementById('grades-class').value;
            const assignmentId = document.getElementById('grades-assignment').value;
            
            if (!classId) {
                document.getElementById('grades-table-body').innerHTML = `
                    <tr>
                        <td colspan="5" class="no-items">Select a class to view grades</td>
                    </tr>
                `;
                return;
            }
            
            try {
                let endpoint = `/teacher/grades?class_id=${classId}`;
                if (assignmentId) {
                    endpoint += `&assignment_id=${assignmentId}`;
                }
                
                const grades = await fetchData(endpoint);
                const tbody = document.getElementById('grades-table-body');
                tbody.innerHTML = '';
                
                if (grades.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="no-items">No grades found for this selection</td>
                        </tr>
                    `;
                    return;
                }
                
                grades.forEach(grade => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${grade.student_id}</td>
                        <td>${grade.student_name}</td>
                        <td>${grade.score !== null ? grade.score : 'Not graded'}</td>
                        <td>${grade.comments || ''}</td>
                        <td class="actions">
                            <button class="action-btn edit-btn" onclick="showEditGradeModal(${JSON.stringify(grade).replace(/"/g, '&quot;')})" aria-label="Edit grade">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteGrade('${grade.id}')" aria-label="Delete grade">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Failed to load grades:', error);
                alert('Failed to load grades: ' + error.message);
            }
        }

        async function loadAnnouncements() {
            try {
                const announcements = await fetchData('/teacher/announcements');
                const tbody = document.getElementById('announcements-table-body');
                tbody.innerHTML = '';
                
                if (announcements.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="no-items">No announcements found</td>
                        </tr>
                    `;
                    return;
                }
                
                announcements.forEach(announcement => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${announcement.id}</td>
                        <td>${announcement.title}</td>
                        <td>${new Date(announcement.created_at).toLocaleDateString()}</td>
                        <td>${announcement.class_name || 'All Classes'}</td>
                        <td class="actions">
                            <button class="action-btn view-btn" onclick="viewAnnouncement('${announcement.id}')" aria-label="View announcement">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit-btn" onclick="showEditAnnouncementModal(${JSON.stringify(announcement).replace(/"/g, '&quot;')})" aria-label="Edit announcement">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteAnnouncement('${announcement.id}')" aria-label="Delete announcement">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Failed to load announcements:', error);
                alert('Failed to load announcements: ' + error.message);
            }
        }

        // Form Handlers
        async function handleClassFormSubmit(e) {
            e.preventDefault();
            
            const classId = document.getElementById('class-id').value;
            const subject = document.getElementById('class-subject').value;
            const grade = document.getElementById('class-grade').value;
            const schedule = document.getElementById('class-schedule').value;
            
            try {
                if (classId) {
                    // Update existing class
                    await fetchData(`/teacher/classes/${classId}`, 'PUT', {
                        subject,
                        grade_level: grade,
                        schedule
                    });
                    alert('Class updated successfully');
                } else {
                    // Create new class
                    await fetchData('/teacher/classes', 'POST', {
                        subject,
                        grade_level: grade,
                        schedule
                    });
                    alert('Class created successfully');
                }
                
                closeModal('class-modal');
                loadClasses();
                updateDashboardCounts();
            } catch (error) {
                console.error('Failed to save class:', error);
                alert('Failed to save class: ' + error.message);
            }
        }

        async function handleAttendanceFormSubmit(e) {
            e.preventDefault();
            
            const classId = document.getElementById('attendance-modal-class').value;
            const date = document.getElementById('attendance-modal-date').value;
            
            if (!classId || !date) {
                alert('Please select a class and date');
                return;
            }
            
            const attendanceRecords = [];
            const statusElements = document.querySelectorAll('#attendance-students-list .attendance-status');
            
            statusElements.forEach(el => {
                attendanceRecords.push({
                    student_id: el.dataset.studentId,
                    status: el.value,
                    date: date
                });
            });
            
            try {
                await fetchData('/teacher/attendance', 'POST', {
                    class_id: classId,
                    date: date,
                    records: attendanceRecords
                });
                
                alert('Attendance saved successfully');
                closeModal('attendance-modal');
                loadClassAttendance();
            } catch (error) {
                console.error('Failed to save attendance:', error);
                alert('Failed to save attendance: ' + error.message);
            }
        }

        async function handleGradeFormSubmit(e) {
            e.preventDefault();
            
            const gradeId = document.getElementById('grade-id').value;
            const classId = document.getElementById('grade-class').value;
            const studentId = document.getElementById('grade-student').value;
            const assignmentId = document.getElementById('grade-assignment').value;
            const score = document.getElementById('grade-score').value;
            const comments = document.getElementById('grade-comments').value;
            
            try {
                if (gradeId) {
                    // Update existing grade
                    await fetchData(`/teacher/grades/${gradeId}`, 'PUT', {
                        student_id: studentId,
                        assignment_id: assignmentId,
                        score: parseFloat(score),
                        comments
                    });
                    alert('Grade updated successfully');
                } else {
                    // Create new grade
                    await fetchData('/teacher/grades', 'POST', {
                        class_id: classId,
                        student_id: studentId,
                        assignment_id: assignmentId,
                        score: parseFloat(score),
                        comments
                    });
                    alert('Grade saved successfully');
                }
                
                closeModal('grade-modal');
                loadClassGrades();
            } catch (error) {
                console.error('Failed to save grade:', error);
                alert('Failed to save grade: ' + error.message);
            }
        }

        async function handleAnnouncementFormSubmit(e) {
            e.preventDefault();
            
            const announcementId = document.getElementById('announcement-id').value;
            const title = document.getElementById('announcement-title').value;
            const classId = document.getElementById('announcement-class').value || null;
            const content = document.getElementById('announcement-content').value;
            
            try {
                if (announcementId) {
                    // Update existing announcement
                    await fetchData(`/teacher/announcements/${announcementId}`, 'PUT', {
                        title,
                        class_id: classId,
                        content
                    });
                    alert('Announcement updated successfully');
                } else {
                    // Create new announcement
                    await fetchData('/teacher/announcements', 'POST', {
                        title,
                        class_id: classId,
                        content
                    });
                    alert('Announcement posted successfully');
                }
                
                closeModal('announcement-modal');
                loadAnnouncements();
                updateDashboardCounts();
            } catch (error) {
                console.error('Failed to save announcement:', error);
                alert('Failed to save announcement: ' + error.message);
            }
        }

        async function handleTaskFormSubmit(e) {
            e.preventDefault();
            
            const taskId = document.getElementById('task-id').value;
            const title = document.getElementById('task-title').value;
            const dueDate = document.getElementById('task-due-date').value;
            const priority = document.getElementById('task-priority').value;
            const description = document.getElementById('task-description').value;
            
            try {
                if (taskId) {
                    // Update existing task
                    await fetchData(`/teacher/tasks/${taskId}`, 'PUT', {
                        title,
                        due_date: dueDate,
                        priority,
                        description
                    });
                    alert('Task updated successfully');
                } else {
                    // Create new task
                    await fetchData('/teacher/tasks', 'POST', {
                        title,
                        due_date: dueDate,
                        priority,
                        description
                    });
                    alert('Task added successfully');
                }
                
                closeModal('task-modal');
                loadPendingTasks();
            } catch (error) {
                console.error('Failed to save task:', error);
                alert('Failed to save task: ' + error.message);
            }
        }

        async function handleProfileFormSubmit(e) {
            e.preventDefault();
            
            const name = document.getElementById('profile-name').value;
            const email = document.getElementById('profile-email').value;
            const subject = document.getElementById('profile-subject').value;
            const currentPassword = document.getElementById('profile-current-password').value;
            const newPassword = document.getElementById('profile-new-password').value;
            const confirmPassword = document.getElementById('profile-confirm-password').value;
            
            try {
                const updateData = {
                    full_name: name,
                    email: email,
                    subject: subject
                };
                
                if (newPassword) {
                    if (newPassword !== confirmPassword) {
                        throw new Error('New passwords do not match');
                    }
                    if (!currentPassword) {
                        throw new Error('Current password is required to change password');
                    }
                    updateData.current_password = currentPassword;
                    updateData.new_password = newPassword;
                }
                
                await fetchData('/auth/profile', 'PUT', updateData);
                alert('Profile updated successfully');
                closeModal('profile-modal');
                loadUserProfile();
            } catch (error) {
                console.error('Failed to update profile:', error);
                alert('Failed to update profile: ' + error.message);
            }
        }

        // Helper Functions
        async function loadClassesForAttendanceModal() {
            try {
                const classes = await fetchData('/teacher/classes');
                const select = document.getElementById('attendance-modal-class');
                select.innerHTML = '<option value="">Select Class</option>';
                
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = `${cls.subject} (Grade ${cls.grade_level})`;
                    select.appendChild(option);
                });
                
                select.addEventListener('change', async function() {
                    if (this.value) {
                        await loadStudentsForAttendance(this.value);
                    } else {
                        document.getElementById('attendance-students-list').innerHTML = '';
                    }
                });
            } catch (error) {
                console.error('Failed to load classes for attendance modal:', error);
            }
        }

        async function loadStudentsForAttendance(classId) {
            try {
                const students = await fetchData(`/teacher/classes/${classId}/students`);
                const container = document.getElementById('attendance-students-list');
                container.innerHTML = '';
                
                if (students.length === 0) {
                    container.innerHTML = '<div class="no-items">No students in this class</div>';
                    return;
                }
                
                students.forEach(student => {
                    const div = document.createElement('div');
                    div.className = 'attendance-student';
                    div.innerHTML = `
                        <div class="student-info">
                            <span>${student.full_name}</span>
                            <span>ID: ${student.id}</span>
                        </div>
                        <select class="attendance-status" data-student-id="${student.id}">
                            <option value="present">Present</option>
                            <option value="absent">Absent</option>
                            <option value="late">Late</option>
                            <option value="excused">Excused</option>
                        </select>
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Failed to load students for attendance:', error);
            }
        }

        async function loadClassesForGradesModal() {
            try {
                const classes = await fetchData('/teacher/classes');
                const select = document.getElementById('grade-class');
                select.innerHTML = '<option value="">Select Class</option>';
                
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = `${cls.subject} (Grade ${cls.grade_level})`;
                    select.appendChild(option);
                });
                
                select.addEventListener('change', async function() {
                    if (this.value) {
                        await loadStudentsForGrade(this.value);
                        await loadAssignmentsForGrade(this.value);
                    } else {
                        document.getElementById('grade-student').innerHTML = '<option value="">Select Student</option>';
                        document.getElementById('grade-assignment').innerHTML = '<option value="">Select Assignment</option>';
                    }
                });
            } catch (error) {
                console.error('Failed to load classes for grades modal:', error);
            }
        }

        async function loadStudentsForGrade(classId) {
            try {
                const students = await fetchData(`/teacher/classes/${classId}/students`);
                const select = document.getElementById('grade-student');
                select.innerHTML = '<option value="">Select Student</option>';
                
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = `${student.full_name} (ID: ${student.id})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load students for grade:', error);
            }
        }

        async function loadAssignmentsForGrade(classId) {
            try {
                const assignments = await fetchData(`/teacher/classes/${classId}/assignments`);
                const select = document.getElementById('grade-assignment');
                select.innerHTML = '<option value="">Select Assignment</option>';
                
                assignments.forEach(assignment => {
                    const option = document.createElement('option');
                    option.value = assignment.id;
                    option.textContent = `${assignment.title} (Due: ${new Date(assignment.due_date).toLocaleDateString()})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load assignments for grade:', error);
            }
        }

        async function loadClassesForAnnouncement() {
            try {
                const classes = await fetchData('/teacher/classes');
                const select = document.getElementById('announcement-class');
                select.innerHTML = '<option value="">All Classes</option>';
                
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = `${cls.subject} (Grade ${cls.grade_level})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load classes for announcement:', error);
            }
        }

        // Action Functions
        async function updateAttendanceStatus(classId, date, studentId, status) {
            try {
                await fetchData('/teacher/attendance', 'POST', {
                    class_id: classId,
                    date: date,
                    records: [{
                        student_id: studentId,
                        status: status,
                        date: date
                    }]
                });
            } catch (error) {
                console.error('Failed to update attendance status:', error);
                alert('Failed to update attendance status: ' + error.message);
            }
        }

        async function showAttendanceNotes(classId, date, studentId) {
            try {
                const notes = prompt('Enter attendance notes:');
                if (notes !== null) {
                    await fetchData('/teacher/attendance/notes', 'POST', {
                        class_id: classId,
                        date: date,
                        student_id: studentId,
                        notes: notes
                    });
                    alert('Notes saved successfully');
                }
            } catch (error) {
                console.error('Failed to save attendance notes:', error);
                alert('Failed to save notes: ' + error.message);
            }
        }

        async function completeTask(taskId) {
            if (confirm('Mark this task as completed?')) {
                try {
                    await fetchData(`/teacher/tasks/${taskId}/complete`, 'PUT');
                    loadPendingTasks();
                } catch (error) {
                    console.error('Failed to complete task:', error);
                    alert('Failed to complete task: ' + error.message);
                }
            }
        }

        async function editTask(taskId) {
            try {
                const task = await fetchData(`/teacher/tasks/${taskId}`);
                
                document.getElementById('task-modal-title').textContent = 'Edit Task';
                document.getElementById('task-id').value = task.id;
                document.getElementById('task-title').value = task.title;
                document.getElementById('task-due-date').value = new Date(task.due_date).toISOString().slice(0, 16);
                document.getElementById('task-priority').value = task.priority;
                document.getElementById('task-description').value = task.description || '';
                
                showModal('task-modal');
            } catch (error) {
                console.error('Failed to load task for editing:', error);
                alert('Failed to load task: ' + error.message);
            }
        }

        async function deleteClass(classId) {
            if (confirm('Are you sure you want to delete this class? This action cannot be undone.')) {
                try {
                    await fetchData(`/teacher/classes/${classId}`, 'DELETE');
                    alert('Class deleted successfully');
                    loadClasses();
                    updateDashboardCounts();
                } catch (error) {
                    console.error('Failed to delete class:', error);
                    alert('Failed to delete class: ' + error.message);
                }
            }
        }

        async function deleteGrade(gradeId) {
            if (confirm('Are you sure you want to delete this grade? This action cannot be undone.')) {
                try {
                    await fetchData(`/teacher/grades/${gradeId}`, 'DELETE');
                    alert('Grade deleted successfully');
                    loadClassGrades();
                } catch (error) {
                    console.error('Failed to delete grade:', error);
                    alert('Failed to delete grade: ' + error.message);
                }
            }
        }

        async function deleteAnnouncement(announcementId) {
            if (confirm('Are you sure you want to delete this announcement? This action cannot be undone.')) {
                try {
                    await fetchData(`/teacher/announcements/${announcementmentId}`, 'DELETE');
                    alert('Announcement deleted successfully');
                    loadAnnouncements();
                    updateDashboardCounts();
                } catch (error) {
                    console.error('Failed to delete announcement:', error);
                    alert('Failed to delete announcement: ' + error.message);
                }
            }
        }

        function showProfile() {
            document.getElementById('profile-dropdown').classList.toggle('show');
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            window.location.href = '/login.html';
        }

        // Theme Switching
        document.querySelectorAll('.theme-switcher button').forEach(button => {
            button.addEventListener('click', function() {
                const theme = this.dataset.theme;
                document.body.className = theme;
                localStorage.setItem('theme', theme);
            });
        });

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.className = savedTheme;

        // Initialize the dashboard when the page loads
        window.onload = initDashboard;

        // Close dropdowns when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.user-profile') && !event.target.closest('.user-profile')) {
                const dropdowns = document.getElementsByClassName('profile-dropdown');
                for (let i = 0; i < dropdowns.length; i++) {
                    const openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        };
    </script>
</body>
</html>